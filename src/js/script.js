// ---- navbar burger handling ---- //
document.addEventListener('DOMContentLoaded', () => {
  // Get all "navbar-burger" elements
  const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  // Check if there are any navbar burgers
  if ($navbarBurgers.length > 0) {
    // Add a click event on each of them
    $navbarBurgers.forEach( el => {
      el.addEventListener('click', () => {
        // Get the target from the "data-target" attribute
        const target = el.dataset.target;
        const $target = document.getElementById(target);
        // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
        el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  }
});

// ----- Cookie Banner ----- //
function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}
function setCookie(cname, cvalue, exdays) {
  const d = new Date();
  d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
  let expires = "expires="+d.toUTCString();
  document.cookie = cname + "=" + cvalue + ";" + expires + "; SameSite=Lax";
}
function checkCookieConsent(){
  // check banner already closed
  let bannerClosed = getCookie("cookie-banner-closed")
  let banner = document.getElementById("cookie-banner")
  if (bannerClosed == "true") banner.classList.add("is-hidden")
  else banner.classList.remove("is-hidden")
  // check cookie-consent
  let consent = getCookie("cookie-consent")
  consent = consent == 'true'
  // check if map is present
  let map1 = document.getElementById('map1')
  if (map1 != null){
    if (consent){
      map1.innerHTML = `<iframe class="has-ratio"
      src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d11680.227838174136!2d12.692656199796973!3d42.956004072483935!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x132e85c52fe700f1%3A0x29b8c4ea64a92138!2sVia%20Maurizio%20Quadrio%2C%2010%2C%2006034%20Foligno%20PG!5e0!3m2!1sit!2sit!4v1636326339997!5m2!1sit!2sit"
      width="400" height="300" style="border:0;" allowfullscreen="" loading="lazy"></iframe>`
     } else {
      map1.innerHTML = ''
    }
  }
  // check if cookie control panel is present
  let consent_google_yes = document.getElementById('consent-google-yes')
  let consent_google_no = document.getElementById('consent-google-no')
  if (consent_google_yes != null){
    if (consent) {
      consent_google_yes.classList.add("is-success")
      consent_google_yes.classList.add("is-selected")
      consent_google_no.classList.remove("is-danger")
      consent_google_no.classList.remove("is-selected")
    } else {
      consent_google_yes.classList.remove("is-success")
      consent_google_yes.classList.remove("is-selected")
      consent_google_no.classList.add("is-danger")
      consent_google_no.classList.add("is-selected")
    }
  }
}
function consentCookies(){
  setCookie("cookie-banner-closed","true",30)
  setCookie("cookie-consent","true",30)
  checkCookieConsent();
}
function rejectCookies(){
  setCookie("cookie-banner-closed","true",30)
  setCookie("cookie-consent","false",30)
  checkCookieConsent();
}
checkCookieConsent()

// ----- html fragment behind menu ----- //
function htmlfragment(document, history, location) {
  var HISTORY_SUPPORT = !!(history && history.pushState);

  var anchorScrolls = {
    ANCHOR_REGEX: /^#[^ ]+$/,
    OFFSET_HEIGHT_PX: 50,

    /**
     * Establish events, and fix initial scroll position if a hash is provided.
     */
    init: function() {
      this.scrollToCurrent();
      window.addEventListener('hashchange', this.scrollToCurrent.bind(this));
      document.body.addEventListener('click', this.delegateAnchors.bind(this));
    },

    /**
     * Return the offset amount to deduct from the normal scroll position.
     * Modify as appropriate to allow for dynamic calculations
     */
    getFixedOffset: function() {
      return this.OFFSET_HEIGHT_PX;
    },

    /**
     * If the provided href is an anchor which resolves to an element on the
     * page, scroll to it.
     * @param  {String} href
     * @return {Boolean} - Was the href an anchor.
     */
    scrollIfAnchor: function(href, pushToHistory) {
      var match, rect, anchorOffset;

      if(!this.ANCHOR_REGEX.test(href)) {
        return false;
      }

      match = document.getElementById(href.slice(1));

      if(match) {
        rect = match.getBoundingClientRect();
        anchorOffset = window.pageYOffset + rect.top - this.getFixedOffset();
        window.scrollTo(window.pageXOffset, anchorOffset);

        // Add the state to history as-per normal anchor links
        if(HISTORY_SUPPORT && pushToHistory) {
          history.pushState({}, document.title, location.pathname + href);
        }
      }

      return !!match;
    },

    /**
     * Attempt to scroll to the current location's hash.
     */
    scrollToCurrent: function() {
      this.scrollIfAnchor(window.location.hash);
    },

    /**
     * If the click event's target was an anchor, fix the scroll position.
     */
    delegateAnchors: function(e) {
      var elem = e.target;

      if(
        elem.nodeName === 'A' &&
        this.scrollIfAnchor(elem.getAttribute('href'), true)
      ) {
        e.preventDefault();
      }
    }
  };

  window.addEventListener(
    'DOMContentLoaded', anchorScrolls.init.bind(anchorScrolls)
  );
}
htmlfragment(window.document, window.history, window.location);